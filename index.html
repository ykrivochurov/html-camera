<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PWA Camera Demo (iPhone)</title>
  <!-- iOS PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="PWA Camera" />
  <!-- Minimal icons (data URIs) -->
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQMAAABmQ2nVAAAABlBMVEX///8AAABVwtN+AAAAEElEQVQ4y2NgGAWjYBSMCAAABSYABT6+Vd0AAAAASUVORK5CYII=" />
  <link rel="icon" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQMAAABmQ2nVAAAABlBMVEX///8AAABVwtN+AAAAEElEQVQ4y2NgGAWjYBSMCAAABSYABT6+Vd0AAAAASUVORK5CYII=" />
  <link rel="icon" sizes="512x512" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADIAQMAAABmQ2nVAAAABlBMVEX///8AAABVwtN+AAAAEElEQVQ4y2NgGAWjYBSMCAAABSYABT6+Vd0AAAAASUVORK5CYII=" />
  <style>
    :root { --ink: #0f172a; --muted:#64748b; --bg:#f8fafc; --accent:#3b82f6; }
    html,body{height:100%;}
    body{margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); background:var(--bg);}    
    header{position:sticky;top:0;z-index:10;background:rgba(248,250,252,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #e2e8f0;}
    .wrap{max-width:920px;margin:0 auto;padding:16px;}
    h1{margin:0;font-weight:700;}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px;}
    @media(min-width:900px){.grid{grid-template-columns:1.25fr .75fr}}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 1px 2px rgba(2,8,23,0.06);}    
    .card .hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e2e8f0}
    .card .bd{padding:16px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button,select,input[type="checkbox"]{font:inherit}
    button{cursor:pointer;border:1px solid #cbd5e1;background:#fff;border-radius:12px;padding:10px 14px}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-block;border:1px dashed #cbd5e1;border-radius:999px;padding:4px 10px;color:var(--muted)}
    video{width:100%;border-radius:12px;background:#000;}
    canvas{max-width:100%;border:1px dashed #e2e8f0;border-radius:12px}
    .note{color:var(--muted);font-size:14px}
    .ok{color:#16a34a}
    .warn{color:#b45309}
    footer{padding:24px 16px;color:var(--muted);text-align:center}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px;}
    .chip{padding:4px 8px;border-radius:8px;background:#eff6ff;border:1px solid #bfdbfe;color:#1e3a8a}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üì∑ PWA Camera Demo ‚Äî iPhone</h1>
      <div class="note">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∫ PWA (–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω ¬´–î–æ–º–æ–π¬ª), –∑–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ, —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ.</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="hd">
          <strong>1) –ü—Ä–µ–≤—å—é —Å –∫–∞–º–µ—Ä—ã (getUserMedia)</strong>
          <span id="permStatus" class="pill">–°—Ç–∞—Ç—É—Å: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <button id="btnStart" class="primary">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="btnStop" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="btnSwitch" disabled>üîÅ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ñ—Ä–æ–Ω—Ç/—Ç—ã–ª</button>
            <label class="row" style="gap:6px"><input type="checkbox" id="cbTorch"/> –§–æ–Ω–∞—Ä–∏–∫</label>
            <span id="modeChip" class="chip">environment</span>
          </div>
          <video id="video" playsinline autoplay muted></video>
          <div class="note">–°–æ–≤–µ—Ç: –Ω–∞ iOS –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é. –ï—Å–ª–∏ —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å¬ª –µ—â—ë —Ä–∞–∑. –§–æ–Ω–∞—Ä–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç—ã–ª–æ–≤–æ–π –∫–∞–º–µ—Ä–µ –∏ –Ω–µ –Ω–∞ –≤—Å–µ—Ö –º–æ–¥–µ–ª—è—Ö/–≤–µ—Ä—Å–∏—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.</div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <strong>2) –°–Ω–∏–º–æ–∫ —Ñ–æ—Ç–æ</strong>
          <span class="pill">Canvas + download</span>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <button id="btnShot" disabled>üì∏ –°–Ω—è—Ç—å –∫–∞–¥—Ä</button>
            <a id="linkPhoto" download="photo.jpg" style="display:none"><button>‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ</button></a>
          </div>
          <canvas id="canvas" width="0" height="0"></canvas>
          <div class="note">–°–Ω–∏–º–æ–∫ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ &lt;canvas&gt;, –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ JPEG.</div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <strong>3) –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ</strong>
          <span id="recSupport" class="pill">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏‚Ä¶</span>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <button id="btnRec" disabled>‚è∫ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
            <button id="btnRecStop" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            <a id="linkVideo" download="video.webm" style="display:none"><button>‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ</button></a>
          </div>
          <div class="note">MediaRecorder –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ iOS 14.3+; –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –≤ PWA –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.</div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <strong>4) Fallback —á–µ—Ä–µ–∑ &lt;input type="file" capture&gt;</strong>
          <span class="pill">–ù–∞–¥—ë–∂–Ω—ã–π –æ–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å</span>
        </div>
        <div class="bd">
          <input id="fileCam" type="file" accept="image/*;capture=camera,video/*" />
          <div id="pickedInfo" class="note" style="margin-top:8px"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><strong>PWA —Å—Ç–∞—Ç—É—Å</strong><span class="pill">–ú–∞–Ω–∏—Ñ–µ—Å—Ç + SW</span></div>
        <div class="bd mono" id="pwaStatus">‚Ä¶</div>
      </section>
    </div>
  </main>

  <footer>
    –°–¥–µ–ª–∞–Ω–æ –∫–∞–∫ –æ–¥–∏–Ω HTML-—Ñ–∞–π–ª. –°–µ—Ä–≤–∏—Å-–≤–æ—Ä–∫–µ—Ä –∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏. –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ HTTPS –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ.
  </footer>

<script>
(async function(){
  const $ = (sel)=>document.querySelector(sel);
  const video = $('#video');
  const canvas = $('#canvas');
  const ctx = canvas.getContext('2d');
  const btnStart = $('#btnStart');
  const btnStop = $('#btnStop');
  const btnSwitch = $('#btnSwitch');
  const btnShot = $('#btnShot');
  const linkPhoto = $('#linkPhoto');
  const permStatus = $('#permStatus');
  const modeChip = $('#modeChip');
  const cbTorch = $('#cbTorch');
  const fileCam = $('#fileCam');
  const pickedInfo = $('#pickedInfo');

  const btnRec = $('#btnRec');
  const btnRecStop = $('#btnRecStop');
  const linkVideo = $('#linkVideo');
  const recSupport = $('#recSupport');

  let currentFacing = 'environment';
  let stream = null;
  let mediaRecorder = null;
  let recordedChunks = [];

  function setPermStatus(t, cls){ permStatus.textContent = '–°—Ç–∞—Ç—É—Å: '+t; permStatus.className = 'pill ' + (cls||''); }

  function supportsMediaRecorder(){ return typeof MediaRecorder !== 'undefined'; }
  recSupport.textContent = supportsMediaRecorder()? 'MediaRecorder: OK' : 'MediaRecorder: –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏';
  if(!supportsMediaRecorder()) recSupport.classList.add('warn'); else recSupport.classList.add('ok');

  async function getPermissionState(){
    try{
      if(!navigator.permissions) return null;
      // Safari –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç query –¥–ª—è camera, –Ω–æ –ø–æ–ø—Ä–æ–±—É–µ–º
      const s = await navigator.permissions.query({ name: 'camera' });
      return s.state; // 'granted' | 'denied' | 'prompt'
    }catch{ return null; }
  }

  async function updatePermLabel(){
    const state = await getPermissionState();
    if(!state) setPermStatus('–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ (Safari)', '');
    else if(state==='granted') setPermStatus('—Ä–∞–∑—Ä–µ—à–µ–Ω–æ', 'ok');
    else if(state==='denied') setPermStatus('–∑–∞–ø—Ä–µ—â–µ–Ω–æ', 'warn');
    else setPermStatus('—Å–ø—Ä–æ—Å–∏—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ', '');
  }

  async function startCamera(){
    try{
      stopCamera();
      const constraints = {
        audio: false,
        video: {
          facingMode: currentFacing,
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 30 }
        }
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // Torch toggle using ImageCapture if supported
      await setupTorch();

      btnStop.disabled = false;
      btnSwitch.disabled = false;
      btnShot.disabled = false;
      btnRec.disabled = !supportsMediaRecorder();
    }catch(err){
      console.error(err);
      alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + err.message);
    }
  }

  function stopCamera(){
    try{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    }catch{}
    stream = null;
    video.srcObject = null;
    btnStop.disabled = true;
    btnSwitch.disabled = true;
    btnShot.disabled = true;
    btnRec.disabled = true;
    btnRecStop.disabled = true;
    cbTorch.checked = false; cbTorch.disabled = true;
  }

  async function switchFacing(){
    currentFacing = (currentFacing === 'environment') ? 'user' : 'environment';
    modeChip.textContent = currentFacing;
    await startCamera();
  }

  async function setupTorch(){
    // Continuous torch works only on some devices & only on rear camera
    try{
      cbTorch.checked = false;
      cbTorch.disabled = true;
      if(!stream) return;
      if(currentFacing !== 'environment'){ cbTorch.disabled = true; return; }
      const [track] = stream.getVideoTracks();
      const caps = track.getCapabilities ? track.getCapabilities() : null;
      if(caps && 'torch' in caps){
        // Some browsers expose boolean torch capability
        cbTorch.disabled = false;
        cbTorch.onchange = async ()=>{
          try{ await track.applyConstraints({ advanced: [{ torch: cbTorch.checked }] }); }
          catch(e){ console.warn('Torch error', e); cbTorch.checked = false; }
        };
      } else {
        // Optional flash-only detection via ImageCapture
        try{
          const ic = new ImageCapture(track);
          const photoCaps = await ic.getPhotoCapabilities();
          // photoCaps.fillLightMode may include 'flash' (single-shot), but no continuous torch
        }catch{}
        cbTorch.disabled = true;
      }
    }catch(e){ cbTorch.disabled = true; }
  }] }); }catch(e){ console.warn('Torch error', e); }
        };
      } else {
        cbTorch.disabled = true;
      }
    }catch(e){ cbTorch.disabled = true; }
  }

  function takePhoto(){
    if(!stream) return;
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    const w = settings.width || 1280;
    const h = settings.height || 720;
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video, 0, 0, w, h);
    canvas.toBlob((blob)=>{
      if(!blob) return;
      const url = URL.createObjectURL(blob);
      linkPhoto.href = url;
      linkPhoto.style.display = 'inline-block';
    }, 'image/jpeg', 0.92);
  }

  function startRec(){
    if(!supportsMediaRecorder() || !stream) return;
    recordedChunks = [];
    try{
      const mr = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
      mediaRecorder = mr;
    }catch(e){
      try{ mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/mp4' }); }catch{ mediaRecorder = new MediaRecorder(stream); }
    }
    mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size) recordedChunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'video/webm' });
      const url = URL.createObjectURL(blob);
      linkVideo.href = url;
      linkVideo.style.display = 'inline-block';
    };
    mediaRecorder.start();
    btnRec.disabled = true;
    btnRecStop.disabled = false;
  }

  function stopRec(){
    if(mediaRecorder && mediaRecorder.state !== 'inactive'){
      mediaRecorder.stop();
    }
    btnRec.disabled = false;
    btnRecStop.disabled = true;
  }

  // Fallback <input>
  fileCam.addEventListener('change', ()=>{
    const f = fileCam.files && fileCam.files[0];
    if(!f){ pickedInfo.textContent = ''; return; }
    pickedInfo.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${f.name} (${Math.round(f.size/1024)} KB, ${f.type||'mime?'})`;
  });

  btnStart.addEventListener('click', startCamera);
  btnStop.addEventListener('click', stopCamera);
  btnSwitch.addEventListener('click', switchFacing);
  btnShot.addEventListener('click', takePhoto);
  btnRec.addEventListener('click', startRec);
  btnRecStop.addEventListener('click', stopRec);

  await updatePermLabel();

  // ====== PWA bits (manifest + service worker) ======
  const pwaStatusEl = document.getElementById('pwaStatus');
  function logPWA(msg){ pwaStatusEl.textContent += `\n${msg}`; }
  pwaStatusEl.textContent = '';

  // Create manifest dynamically so –≤—Å—ë –±—ã–ª–æ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
  const manifest = {
    name: 'PWA Camera Demo',
    short_name: 'CameraDemo',
    start_url: '.',
    display: 'standalone',
    background_color: '#ffffff',
    theme_color: '#3b82f6',
    icons: [
      { src: document.querySelector('link[rel="icon"][sizes="192x192"]').href, sizes: '192x192', type: 'image/png' },
      { src: document.querySelector('link[rel="icon"][sizes="512x512"]').href, sizes: '512x512', type: 'image/png' }
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const manifestURL = URL.createObjectURL(manifestBlob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = manifestURL;
  document.head.appendChild(link);
  logPWA('–ú–∞–Ω–∏—Ñ–µ—Å—Ç —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–¥–∫–ª—é—á—ë–Ω.');

  // Register Service Worker from a Blob to keep single-file demo
  const swCode = `
    self.addEventListener('install', (e)=>{
      e.waitUntil((async()=>{
        const cache = await caches.open('pwa-camera-v1');
        await cache.addAll(['./']);
      })());
      self.skipWaiting();
    });
    self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', (e)=>{
      const url = new URL(e.request.url);
      if(url.origin === location.origin){
        e.respondWith((async()=>{
          const cache = await caches.open('pwa-camera-v1');
          const cached = await cache.match(e.request);
          if(cached) return cached;
          try{
            const res = await fetch(e.request);
            if(e.request.method === 'GET' && res.status === 200){ cache.put(e.request, res.clone()); }
            return res;
          }catch(err){ return cached || Response.error(); }
        })());
      }
    });
  `;
  if('serviceWorker' in navigator){
    const swBlob = new Blob([swCode], { type: 'text/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    try{
      const reg = await navigator.serviceWorker.register(swUrl);
      logPWA('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.');
    }catch(err){
      logPWA('SW –æ—à–∏–±–∫–∞: '+err.message);
    }
  } else {
    logPWA('Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.');
  }

  // iOS install detection helper
  const isInStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  logPWA('–†–µ–∂–∏–º: ' + (isInStandalone ? 'Standalone (A2HS)' : 'Browser tab'));
  if(!isInStandalone){
    logPWA('–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞ iPhone –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª.');
  }
})();
</script>
</body>
</html>
